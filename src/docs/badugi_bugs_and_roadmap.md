# Badugi App - Bug List & Roadmap\n\nInternal tracker for known issues, fixes, and upcoming work across gameplay, UI, logging, AI, and infrastructure.\n\n---\n\n## 1. Bugs & Fix Plans\n\n### 1-1. Stack / Betting Flow\n\n#### Bug-01: Busted player stack becomes negative\n- Status: DONE\n- Cause: Blind payments were not clamped to 0 and `isBusted` stayed false after all-in.\n- Fix: Clamp via `Math.max(0, stack - pay)` and persist `isBusted` between streets.\n\n#### Bug-02: Multi-player all-in never closes the BET round\n- Status: DONE\n- Cause: `isBetRoundComplete` only compared bet sizes.\n- Fix: Track `hasActedThisRound` for every action (fold/all-in included) and share the same check in UI + engine so action automatically jumps to DRAW.\n\n### 1-2. Round Transitions / Turn Order\n\n#### Bug-03: DRAW start seat is wrong\n- Status: DONE\n- Fix: Single source of truth via `calcDrawStartIndex(dealer, streetIndex)` and feeding it to `runDrawRound`.\n\n#### Bug-04: BET termination ambiguous\n- Status: DONE\n- Fix: Added `lastAggressor` plus `closingSeatForAggressor` to detect when the raiser is reached again, together with `hasActedThisRound` to close streets deterministically.\n\n### 1-3. Showdown / Evaluator\n\n#### Bug-05: UI display vs Badugi evaluator mismatch\n- Status: DONE\n- Cause: UI still referenced the deprecated `ev.score` / `uniqueCount` fields although `evaluateBadugi` now returns `{ rankType, ranks, kicker, isBadugi }`.\n- Fix: `ui/App.jsx` now logs hands via `rankType` + `ranks` and NPC draws rely on the new `npcAutoDrawCount()` helper that reads `kicker`. `score` was fully removed.\n- Tests: Run `npm test` (Vitest) focusing on `games/badugi/logic/__tests__/roundFlow.test.js`, then manual sanity-check NPC draws (4-card pat, 3-card draws).\n\n### 1-4. UI / Layout\n\n#### Bug-06: CPU stack/bet info is hard to read\n- Status: DONE\n- Fix: Added the left-column `PlayerStatusBoard` HUD (`ui/components/PlayerStatusBoard.jsx`) that lists every seat's name, position label, stack, current bet, and badges (YOU / ALL-IN / FOLDED / BUSTED / ACTING). The board references `specs/06_player_status_board.md` and keeps CPU stacks visible even when their cards are face down.\n\n#### Bug-07: Seat layout breaks on resize\n- Status: DONE\n- Fix: `ui/App.jsx` now renders seats via a responsive grid (mobile) and Tailwind `lg:absolute` anchors (desktop). `Player.jsx` gained BTN badges and ASCII-only status chips so resizing no longer corrupts layout.\n\n### 1-5. History Log\n\n#### Bug-08: Action history misses intermediate steps\n- Status: DONE\n- Fix: `recordActionToLog` now writes a normalized entry (`phase`, `round`, `seatName`, `stackBefore/After`, `betBefore/After`, `potAfter`, `metadata`) for every BET/DRAW/SHOWDOWN action, including NPC moves and pot distribution. Draw metadata includes `drawInfo` snapshots, and the JSONL exported via `utils/history_rl.js` now contains every intermediate step.\n\n---\n\n## 2. Upcoming Work (short list)\n\n- [x] Test automation: extend `npm test` with UI snapshots / scraping diff checks (Playwright harness lives under `tests/scraping/`).\n- [x] Core game:\n  - [x] Tournament structure: blind/ante/starting stack schedule now drives every deal (level tracker + hand counter in `ui/App.jsx`).\n  - [x] Seat states: Seat Manager overlay controls Human / CPU / Empty per seat, optional auto-rotation, and per-seat redeal/reset helpers.\n  - [x] Side pots: `settleStreetToPots` carries folded contributions and eligibility fixes so multi-pot payouts are accurate.\n- [ ] AI / Learning: HandRecord and TournamentRecord, 4 AI difficulty presets, Python RL (Q-table / ONNX) ingestion.\n- [ ] UI / Effects: Tailwind plus Framer Motion refresh, chip animations, win/lose effects, card squeeze.
- [ ] Tournament mode: implement CPU-only tournament flow (stage timebank, roster, personalities) and link it from the title screen.
- [ ] Seat layout: preserve the current 6-max ellipse (BTN bottom, SB/BB left column, UTG top center, MP/CO right column) as the canonical spacing for all future UI work.
- [x] BET flow: treat folded/all-in seats as satisfied for all-check detection so BET rounds close after checks (e.g., hero busts + SB foldケース). `closingSeatForAggressor` now also skips folded/all-in aggressors.
- [x] All-in handling: ensure sanitizeStacks only flips `allIn` without marking players BUSTED/hasDrawn so they continue to DRAW/SHOWDOWN properly.
- [x] Aggressor tracking: shift `lastAggressor` / `betHead` to the next live seat whenever a tracked player folds (prevents SB fold soft-locks).
- [ ] Seat layout: preserve the current 6-max ellipse (BTN bottom, SB/BB left column, UTG top center, MP/CO right column) as the canonical spacing for all future UI work.
- [ ] Chip HUD: display stack/bet values next to avatars with chip icons and bet size callouts (future UI revamp).
- [ ] Settings / Themes: title/profile customization (/settings) is live; next add felt/HUD theme selectors and layout presets before entering /game.\n- [ ] Platform: PWA plus FastAPI layering, auth and history APIs, E2E + unit suites, keep this spec in sync for Codex/Continue.\n\n## Reinforcement Learning (Badugi)\n\nGoal: train self-play agents for 6-max Badugi and use them as CPU opponents (including "iron-strong" boss characters).\n\n### Current status\n\n- [x] Implemented `rl/env/badugi_env.py` as a Gym-style environment for Badugi.\n\n- [x] Add DQN agent implementation in `rl/agents/dqn_agent.py` and replay buffer in `rl/utils/replay_buffer.py`.\n- [x] Implement the self-play training script `rl/training/train_dqn.py` and verify that episodes run end-to-end without crashes.\n- [x] Move `badugi_env.py` under `rl/env/`, normalize the observation vector, and convert the implementation/comments to ASCII.\n- [x] Add `rl/requirements.txt` and `rl/README.md` so numpy/torch/gymnasium installs are one command away.\n- [ ] Connect the existing hand history / JSONL logging so that Badugi games played in the app can be reused as offline RL data.\n- [ ] Train a baseline DQN model on CPU and save checkpoints under `rl/models/`.\n- [ ] Export a compact model (e.g. via ONNX or a light-weight policy format) so that the React frontend can load it and use it for different AI difficulty tiers.\n- [ ] Tune rewards and observation/action spaces to make the agent strong but still "human-like" and fun to play against.\n- UI / Effects: Tailwind plus Framer Motion refresh, chip animations, win/lose effects, card squeeze.\n- Platform: PWA plus FastAPI layering, auth and history APIs, E2E + unit suites, keep this spec in sync for Codex/Continue.\n\n---\n\n## 3. Operating Rules\n\n1. Bug fix checklist: update `docs/bug_fixes*.md`, `docs/known_bugs.md`, and the snippet -> run `npm test` -> `git add -p` -> `git commit -m "fix: Bug-XX ..."` -> `git push origin bug-fix`. Always push right after the fix (user handles credentials if needed).\n2. Recording: add every new bug to Section 1, flip the Status to DONE once finished, and note the verification steps.\n3. Spec hygiene: new features go to Section 2 with bullets; process changes must be reflected in Section 3.
4. Roadmap discipline: log every new task in Section 2 with a checkbox and flip it to [x] right after the fix/tests/push cycle completes.\n5. Table HUD layout: keep PlayerStatusBoard / Seat Manager outside the yellow table boundary and keep card fans in a single horizontal row to avoid collisions.\n
