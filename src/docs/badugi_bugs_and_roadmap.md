## 5. Spec 09+ Implementation Backlog

All spec documents from 09 onward are still unimplemented. The following task lists describe every remaining item. Check `[x]` when a task is complete; leave `[ ]` when it still needs work.

### Spec 09: Game Engine Abstraction / Multi-Game Architecture
- [x] Shared models in `games/core/models.js` align Badugi with the future engine.
- [x] `GameEngine` base class (`games/core/gameEngine.js`) exposes init/forced-bet/action/showdown/observation APIs.
- [x] Added base classes for draw/board/stud families.
- [x] `GameEngineContext` + `GameEngineProvider` allow switching engines via `?game=` query.
- [x] Move legacy `roundFlow.js` / `drawRound.js` / `showdown.js` logic into BadugiEngine.
- [x] Register BadugiEngine in `engineRegistry.js` and cover it with a unit test.
  - [x] Drive `ui/App.jsx` updates exclusively through GameEngine state.
- [x] `BadugiEngine.getObservation()` returns pot/street/acting seat data for RL.
- [x] `engineTableRef` + `syncEngineTableSnapshot()` keep UI logs and engine state in sync.
- [x] Add dedicated engine-focused unit tests (`games/__tests__/badugiEngine.test.js`).
- [x] Introduce domain-specific exceptions (e.g., `IllegalActionError`).
- [x] Mirror engine metadata (`currentBet` / `betHead` / `lastAggressor`) into UI state after every forced bet/action.
- [x] Hero BET handlers delegate to shared reducers (`resolveHeroFold/Call/Raise`) so logic is centralized before moving into BadugiEngine.
- [x] NPC BET handlers share the same dispatcher so Fold/Call/Raise logging and engine metadata remain consistent regardless of who acts.
- [x] Implement BET action resolution (`Fold/Call/Raise`) inside `BadugiEngine.applyPlayerAction()` and treat UI handlers as thin wrappers.
  - `ui/App.jsx` already calls the `resolve*` helpers and merges engine data via `mergeEnginePlayers()` so the UI only handles logging and animation.
- [ ] Document the migration plan in `docs/engine_migration.md`.

### Spec 10: Multi-Game List & Requirements
- [x] Enumerate every variant in `games/config/multiGameList.json` (Hold'em / Omaha / Draw / Stud / Dramaha).
- [x] Define `games/config/variantProfiles.js` (deck size, evaluator type, street flow, summary).
- [x] Extend GameSelector UI with family tabs, search, and variant cards (`/games` route + Title nav button).
- [x] Implement `resolveGameProfile()` so the UI can derive blind/ante/stack metadata per variant.
- [x] Add requirement checks (`games/core/requirements.js`) so the UI knows when board/draw/stud renderers are needed.
- [x] Feed variant data into Mixed Game rotation (Mixed builder now consumes `GAME_VARIANTS` plus status flags).
- [x] Export variant metadata JSON for RL/AI tooling via `npm run variants:export` -> `src/docs/variant_metadata.json`.
- [x] Add i18n entries for variant names/descriptions (`src/i18n/variants.ja.json` auto-generated).
- [x] Generate `docs/game_catalog.md` summarizing every variant (auto-generated by the export script).
- [x] Add sanity tests that validate each variant definition (`games/config/__tests__/variantCatalog.test.js`).

### Spec 11: Mixed Game Spec
- [x] Create `config/mixed/mixedProfiles.json` with rotation presets, hand counts, and timers.
- [x] Build a Mixed Game editor UI at `/mixed` so designers can tweak game lists, timers, and category toggles.
- [x] Implement `MixedGameContext` controller that swaps GameEngines hand-by-hand and persists runtime state.
- [x] Display current and next game in the HUD plus overlay badges.
- [x] Integrate rotation state with `tournamentManager` and seat rebalancing (persisted `mixedState` syncs the multi-table session).
- [x] Apply correct blind/ante rules for ring vs tournament rotations (variant profiles drive forced bets per stage).
- [x] Log Mixed-game hands to Spec08 history with `gameId`, rotation metadata, and the `MIXED_GAME_SWITCH` marker.
- [x] Add rotation flow tests that cover sequence correctness, HUD updates, and save/resume behavior.

### Spec 12: World Championship Unlock
- [x] Track unlock state in `playerProgress` (stage win counters, timestamps, clear counts).
- [x] Implement `computeUnlockState()` so the UI can show the required win chain and highlight the next milestone.
- [x] Build unlock animation modal and wire it into GameSelector and Title (Mixed button + HUD messaging).
- [x] Gate menus and Mixed profiles based on unlock state (Title, GameSelector, Mixed builder).
- [x] Store unlock events in tournament history plus Spec08 logs (`WORLD_CHAMP_CLEAR` / `WORLD_CHAMP_RECLEAR`).
- [x] Add unit coverage for unlock helpers (`ui/utils/__tests__/playerProgress.test.js`).

### Spec 13: Codex Automated Development Pipeline
- [x] Add `.devtools/auto_tasks.yaml` with at least five sample tasks.
- [x] Provide `.devtools/codex_prompt_template.txt` with token placeholders.
- [x] Implement `.devtools/codex_worker.js` (load task -> build prompt -> call Codex -> write file -> git commit/PR).
- [x] Create unit tests covering worker error paths (YAML parse, empty output, duplicate PR).
- [x] Add `.github/workflows/codex_nightly.yml` (daily schedule + manual dispatch).
- [x] Archive worker logs as Action artifacts.
- [x] Enforce commit/PR naming: "Codex AutoPR - {{TASK_ID}} {{TASK_TITLE}}".
- [x] Mark tasks as `skipped` when Codex output is invalid.
- [x] Document the pipeline in `docs/codex_pipeline.md`.

### Spec 14: Evaluator Architecture
- [x] Implement unified evaluator API in `games/evaluators/core.js`.
- [x] Build a shared high-hand evaluator for Hold'em / Omaha / Stud high variants.
- [x] Build lowball evaluators (2-7, A-5) and Badugi low/high implementations.
- [x] Add split-pot helpers (Hi-Lo8, Badeucey, Badacey) that return primary and secondary ranks.
- [x] Register evaluators through `games/evaluators/registry.js` and expose `evaluateHand`.
- [x] Migrate the Badugi engine and utils to the new registry and remove legacy evaluator logic.
- [x] Add `games/evaluators/__tests__/evaluator.test.js` plus Badugi engine tests to cover payouts/ties.
- [x] Document the architecture in this roadmap entry while keeping the API pure and side-effect free.
- [x] Provide hooks for future benchmarking scripts via the registry (split evaluator components are modular).

### Spec 15: UI / UX Flow
- [x] Move design tokens (color, spacing, typography) into `styles/designTokens.js`.
- [x] Redesign Title Screen per Spec 15 (hero copy + START to Main Menu flow).
- [ ] Further evolve the Title/Main Menu flow to match the requested "ジャン魂" style: separate Tournament vs Ring unlock lanes, embed the ring/dan game picker (Badugi / PLO / 2-7) inside the Ring entry, expose gear/settings and ?/rules affordances, and gate P2P (friend match) sessions behind a pre-game configuration screen so the Title screen can act as the central hub mentioned in the roadmap.
- [x] Rebuild Main Menu / GameSelector navigation hierarchy with unlock badges.
  - [x] Create Mixed Game setup UI (Spec 11 integration).
- [x] Refresh Tournament setup with Spec 17 blind-sheet previews.
- [x] Refactor Table Screen into reusable subcomponents (TableSummaryPanel + modalized Seat Manager + Notification wrapper).
- [x] Add Result screens (ring / tournament / mixed overlays).
  - [x] `HandResultOverlay` shows pot, winners, and Mixed rotation context.
  - [x] `TournamentResultOverlay` summarizes placement, prize, and next actions.
  - [x] Expand History screen with filters, search, and a detail drawer.
  - [x] Extend Settings screen (theme, audio, controller, pipeline status).
 - [x] Standardize modal and notification components (new `ui/components/Modal.jsx` + `Notification.jsx` powering Seat Manager and status messaging).
- [x] Codify responsive design rules (Title/Menu/Selector now use shared tokens and grids).
- [x] Monitor UI performance targets (load < 3 s, interaction < 100 ms) via UI perf instrumentation + Notification HUD.

### Spec 16: Mixed Game Pro
- [x] Add pro rotation presets (HORSE / 8-Game / 10-Game / Dealer's Choice) and surface quick-load cards throughout Game Selector + Mixed Builder.
- [x] Support weighted rotation and category-based Dealer's Choice modes (`WEIGHTED` / `CATEGORY` filters in the UI).
- [x] Implement pro rules (declaration, bring-in, kill blinds) with validation via `games/config/proRules.js` and SB/BB kill mechanics.
- [x] Add a pro HUD that highlights formats, bet sizing, and rotation context.
- [x] Enforce rule violations with UI warnings (`ruleWarnings` HUD + `PRO_RULE_WARNING` event).
- [ ] Hook Spec 18 AI profiles for pro rotations.
  - [x] Already wired `config/mixed/proAiProfiles.js` plus NPC BET/DRAW handlers to support those profiles.
- [x] Extend logging/history for pro rotations (`recordActionToLog` records format, selection mode, weighted tables, and history metadata).
- [x] Dealer's Choice roulette emits `DEALERS_CHOICE_SWITCH` and keeps the HUD and queue up to date.
- [x] `ui/dealersChoice/dealerChoiceManager.test.js` records FIFO queue behavior for the roulette loader.
- [x] Auto-disable Dealer's Choice during Mixed/Tournament mode so HUD/forced bets stay consistent.
- [x] Call `disableDealerChoiceMode("tournament")` and emit `dealersChoice:disabled` when a tournament starts.
- [x] Playwright scenario `python -m tests.scraping.runner dealers-choice` runs spin -> select -> deal flows.
- [x] Add Playwright scenarios for rotation, kill blinds, and declaration warnings (`mixed-rotation`, `pro-rules`).
- [x] Dealer's Choice roulette queue links `/game?mode=dealers-choice` and ships with `tests/scraping/scenarios/dealers_choice.md`.

### Spec 17: Pro Tournament System
- [x] Define pro blind sheets (`config/tournament/proBlindSheets.json`).
- [x] Implement advanced multi-table balancing and logs (`session.tableBalanceLog` tracked in `tournamentManager` + tournament UI log panel).
- [x] Add a break system with timers and UI countdown (`TournamentScreen` displays break countdown tailored to each stage's blind sheet).
- [x] Implement final-table presentations (new `FinalTableOverlay` featuring remaining players, log snippet, and CTA).

### Spec 19: CPU Difficulty Tier System
- [x] Create `config/ai/tiers.json` (Novice -> Boss -> WorldMaster equivalent) to drive CPU tuning.
- [x] Track KPI metrics (VPIP/PFR/AF/Bluff/SD%) per CPU via `opponentModel`.
- [x] Wire tier parameters (ranges, raise sizes, draw counts) into NPC logic.
- [x] Auto-assign tiers per tournament stage / Mixed profile.
- [x] Implement dynamic difficulty adjustments (KPI-driven tier drift after showdowns).
- [x] Map tiers to AI models (Spec 18) via `resolveTierModelInfo` + ONNX registry.
- [x] Show tier badges/tooltips in the HUD (PlayerStatusBoard overlay).
- [x] Log tier changes (Spec 08) with KPI snapshots and reasons.
- [x] Add developer tuning panel (Title Settings > AI Tier Tuning).

### Spec 20: User Rank / P2P Global Rating
- [x] Implement rating state (Skill/Style/Mixed) in `ui/utils/ratingState.js` + `useRatingState`.
- [x] Build Elo/Elo-lite updater (`applyMatchRatings`) with history + system log hooks.
- [x] Analyze style metrics (aggression, bluff rate, showdown rate) via style diagnostics + profile buckets.
- [x] Compute mixed rating using rotation history (rotation history + mixed weight).
- [x] Feed P2P match data into the RL pipeline (capture buffer + export helper).
- [x] Build global leaderboard UI with filters/search (/leaderboard).
- [x] Add anti-cheat heuristics for rating anomalies (delta + farming detection).
- [x] Show rating badges on Title / Tournament screens (rating HUD cards).
- [x] Extend Spec08 logs with rating updates (system events + history entries).

### Spec 21: Backend API / Server Sync
- [x] Scaffold `server/` (FastAPI + routers + requirements).
- [x] Implement auth (API key header) and client SDK (token + demo flows).
- [x] Add main API endpoints (`/profile`, `/history`, `/tournament`, `/tasks`, `/ai-models`).
- [x] Implement sync manager (delta + snapshot) on the client.
- [x] Define DB schema (players, sessions, ratings, models, unlocks) via in-memory datastore.
- [x] Add AI model sync endpoints (Spec 18).
- [x] Support tournament resume API.
- [x] Add security middleware (rate limit, validation, audit log).
- [x] Provide CLI tools for Codex pipeline to hit the API (`server/cli/sync_cli.py`).
- [x] Add CI contract tests (`server/tests/test_contract.py` verifies `/openapi.json` schema entries).

### Spec 22: P2P Online Play Pre-design
- [x] Implement `p2p/roomManager.ts` (lobbies, matchmaking, spectators, queue log).
- [x] Build WebSocket sync layer + message schema.
  - [x] Secure card distribution (hashing, verification) via `p2p/security.ts` + secure tokens.
- [x] Implement P2P gameplay state machine (deal -> action -> showdown).
- [x] Log P2P matches with Spec08 schema.
- [x] Hook P2P results into ratings (Spec 20).
- [x] Handle connection loss (reconnect, bot takeover, timeouts).
- [x] Prepare cross-platform input handling (shared AsyncAPI doc ensures consistent interfaces for PC/iOS/Android).
- [x] Stub spectator mode and WebRTC direct mode for future work (`p2p/webrtc_stub.ts`).
- [x] Publish REST + WebSocket API docs (OpenAPI/AsyncAPI + `docs/json/p2p_sync_schema.json`/`docs/asyncapi/p2p_ws.yaml`).
- [x] Append `docs/p2p_sync_spec.md` as draft spec for synchronization schema.
- [x] Add anti-cheat / fairness monitoring for online games (action timing warnings + logs).

### Spec 23: App.jsx State Restoration
- [x] Reconciled `ui/App.jsx` behaviors with `docs/bug_fixes.md`/`docs/engine_migration.md` (seat manager, hero tracker + rating HUD, developer panel, SB/BB clamps, draw/bet transitions, logging, metadata sync) so nothing moved during the rollback.
- [x] Verified the App helpers described in the docs (`hasActedThisRound` / `setHasActedFlag`, `shiftAggressorsAfterFold`, `recordActionToLog` wiring for hero/NPC actions) and added hero tracker persistence plus the existing developer panel toggles (tier override, P2P capture + export) so the same troubleshooting points are observable.
- [x] Captured the above findings here as the Spec23 summary so the checklist can be marked complete for future audits (hero tracker state now saves via `localStorage`, logging flows through the new helper, and the developer toggles remain visible in the panel).
- [x] Expanded showdown logging / fallback handling to print every seat’s cards, evaluation, and pot eligibility before payouts so hero’s Badugi hand can’t be skipped and the new traces feed Playwright/QA.
- [ ] Stabilize the draw→bet→draw transition path after SB folds by forcing `finishBetRoundFrom` to refresh `turn`/`betHead` and confirming the Playwright `draw-rollback` spec runs without hitting the third trace timeout.
- [ ] Log active player lists at every `finishDrawRound`/`finishBetRoundFrom` boundary so we can compare them with Playwright traces and detect inconsistencies in the round-start/end active set, especially when someone folds mid-round.
- [ ] Add a “all active seats have acted” check in `finishBetRoundFrom` so that Draw only begins when every remaining player has had a turn; warn/log when a player still needs action and continue from that seat instead of jumping ahead.

### Documentation & localization housekeeping
- [ ] Move `src/docs/current_bugs.md` to `docs/bugs/current_bugs.md`, archive any corrupted copies, and update references so the blocker registry has one canonical UTF-8 location.
- [x] Relocated `config/tournamentStructure.js` into `src/tournament/tournamentStructure.js` and updated the import in `ui/App.jsx` so everybody shares the same source file.
- [ ] Build a centralized comment catalog: create parallel Japanese/English resources (e.g., `src/i18n/comments_ja.json` and `src/i18n/comments_en.json` plus `ui/utils/commentCatalog.js`) that describe every HUD prompt/logging string, and have `App.jsx`/HUD helpers read from that catalog before emitting console output or overlay text so that comment localization and E2E debugging remain synchronized.

## 未完了のロードマップタスク（Phase 単位でのブレイクダウン）
以下は現時点で実装が追いついていない大きなフェーズと、それぞれを進めるための分解タスクです。

### Phase 0：マルチゲーム基盤構築
- [ ] GameEngine 抽象クラスを `games/core` に実装し、`initGame`／`dealInitialCards`／`runBettingRound`／`runShowdown`／`evaluateHand` を定義、BadugiEngine ほかをこの基底から派生させる。
- [ ] Player/Pot/Action データ構造を共通化し、今後のゲームが同じ API で動けるようにする。
- [ ] GameSelector UI、カード描画コンポーネント、賭けコントロール UI を共通化して、各ゲーム固有 UI はモジュール化・差し替え可能に。
- [ ] `bettingRules.js`／`drawRules.js`／`studRules.js`／`hiLoRules.js` を作り、各ゲームに適したフローをプラグインする仕組みを確立。
- [ ] DeckManager を拡張し、Joker/ARCHIE 用セットやマルチドロー、シャッフル戦略をゲーム横断で利用できるように。
- [ ] EvaluateHand を登録する evaluator registry を実装し、Badugi, Deuce-to-Seven, Ace-to-Five, Hold'em, Omaha, Stud, Hi/Lo を登録済みにする。

### Phase 1〜4：Hold’em／Draw／Dramaha／Stud 系
- [ ] NLH/FLH のプリフロップ〜ショーダウンのフロー（コミュニティカード、サイドポット、スタイル判定）を実装。
- [ ] PLO/FLO8/PLO8/Big-O で必須の 2-from-hand 選択や Hi/Lo チェック、AI 用ハンドレンジをサポートする。
- [ ] Draw Game（2-7, A-5, Badacey/Badeucey, ARCHIE, Hidugi）向けに 5 枚初期配布、Discard UI、マルチドロー制御、専用評価器、スプリット処理を組み込み。
- [ ] Dramaha/Stud 系それぞれの配り方・ベットラウンド・評価器（High/2-7/Razz/Razzdugi/Razzdeucey など）を共通APIに追加。

### Phase 5〜6：横断機能・配布準備
- [ ] トーナメントのブラインド構造、Mixed rotation、チップ移動などを共通化し、全ゲームで同じトーナメントループを使えるように。
- [ ] GameRecord/JSONL 履歴、EV・アクション分析、AI 用観測空間、Max-difficulty CPU（鉄強/キャラベース）を作り込み、共通AIパイプラインで活用。
- [ ] チート対策、オフラインプレイ、PWA 化、各プラットフォーム（Windows/Mac/iOS/Android）で動作するインストーラ＆アップデートフローを整備。

これらは全体ロードマップの中でも未着手の大きなブロックなので、優先度に応じて順次取り組む必要があります。
